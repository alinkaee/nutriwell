{% extends 'accounts/base_dashboard.html' %}
{% load url_utils %}

{% block title %}Мои клиенты — Чистый Баланс{% endblock %}

{% block content %}
<h2><i class="bi bi-people me-2"></i>Мои клиенты</h2>

<!-- Кнопка приглашения -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <h5>Все клиенты</h5>
  <a href="{% url 'accounts:invite_client' %}" class="btn btn-primary">+ Пригласить клиента</a>
</div>

<!-- Форма фильтрации -->
<div class="card mb-4">
  <div class="card-body">
    <form id="filter-form" method="get"
          hx-get
          hx-target="#clients-table"
          hx-push-url="true"
          hx-trigger="input delay:500ms, change"
          class="row g-3">
      <div class="col-md-3">
        {{ filter.form.search }}
      </div>
      <div class="col-md-3">
        {{ filter.form.goal }}
      </div>
      <div class="col-md-2">
        {{ filter.form.program_status }}
      </div>
      <div class="col-md-2">
        {{ filter.form.activity }}
      </div>
    </form>
  </div>
</div>

<div id="clients-table">
  {% include 'accounts/nutritionist/partials/clients_table.html' %}
</div>

<!-- Список всех клиентов для ручной привязки -->
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <span>Все зарегистрированные пользователи (для ручной привязки)</span>
    {% if all_clients.paginator.num_pages > 1 %}
      <small class="text-muted">Страница {{ all_clients.number }} из {{ all_clients.paginator.num_pages }}</small>
    {% endif %}
  </div>
  <div class="card-body">
    {% for client in all_clients %}
      <div class="card mb-2">
        <div class="card-body d-flex justify-content-between align-items-center">
          <div>
            <strong>{{ client.user.get_full_name|default:client.user.email }}</strong>
            {% if client.goal %}<br><small>Цель: {{ client.goal|truncatewords:6 }}</small>{% endif %}
          </div>
          <div class="d-flex gap-2">
            {% if client.id in my_client_ids %}
              <span class="badge bg-success">Ваш клиент</span>
              <a href="{% url 'chat:chat_view' client.user.id %}" class="btn btn-sm btn-outline-info">
                <i class="bi bi-chat-dots"></i> Чат
              </a>
            {% else %}
              <a href="{% url 'accounts:assign_client' client.id %}" class="btn btn-sm btn-primary">Привязать</a>
            {% endif %}
      </div>
    {% empty %}
      <p class="text-muted">Нет зарегистрированных клиентов.</p>
    {% endfor %}

    <!-- Пагинация для всех клиентов -->
    {% if all_clients.has_other_pages %}
      <nav aria-label="Пагинация всех клиентов">
        <ul class="pagination justify-content-center mt-3">
          {% if all_clients.has_previous %}
            <li class="page-item">
              <a class="page-link"
                 href="?{% url_replace request 'page_all' all_clients.previous_page_number %}">
                &laquo;
              </a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
          {% endif %}

          {% for num in all_clients.paginator.page_range %}
            {% if all_clients.number == num %}
              <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% else %}
              <li class="page-item">
                <a class="page-link"
                   href="?{% url_replace request 'page_all' num %}">
                  {{ num }}
                </a>
              </li>
            {% endif %}
          {% endfor %}

          {% if all_clients.has_next %}
            <li class="page-item">
              <a class="page-link"
                 href="?{% url_replace request 'page_all' all_clients.next_page_number %}">
                &raquo;
              </a>
            </li>
          {% else %}
            <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
          {% endif %}
        </ul>
      </nav>
    {% endif %}
  </div>
</div>

{% endblock %}