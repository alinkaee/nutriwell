{% extends 'accounts/base_dashboard.html' %}

{% block title %}Мой прогресс — Чистый Баланс{% endblock %}

{% block content %}
<h2><i class="bi bi-graph-up me-2"></i>Мой прогресс</h2>

<!-- Подсказка -->
<div id="progress-help-alert" class="alert alert-info alert-dismissible fade show" role="alert">
  <i class="bi bi-info-circle me-2"></i>
  <strong>Как вести прогресс:</strong><br>
  Добавляйте запись раз в неделю — фиксируйте вес, обхваты и настроение.<br>
  Это поможет вам и вашему нутрициологу оценить результат!
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Закрыть"></button>
</div>

<div class="mt-3">
  <a href="{% url 'diaries:progress_pdf' %}" class="btn btn-outline-secondary">
    <i class="bi bi-file-earmark-pdf me-2"></i>Скачать отчёт (PDF)
  </a>
</div>

<!-- Слайдер графиков -->
<div class="nutrition-slider-container mb-4">
  <div class="nutrition-slider">
    <!-- График веса -->
    <div class="nutrition-slide">
      <div class="card" style="height: 100%; width: 100%; background-color: white; color: black; border: white;">
        <div class="card-header" style="background-color: white; color: black; border: white;">Динамика веса</div>
        <div class="card-body" style="height: 100%; width: 100%;">
          <canvas id="weightChart" style="height: 100%; width: 100%;"></canvas>
        </div>
      </div>
    </div>

    <!-- График объёмов -->
    <div class="nutrition-slide">
      <div class="card" style="height: 100%; width: 100%; background-color: white; color: black; border: white;">
        <div class="card-header" style="background-color: white; color: black; border: white;">Объёмы (см)</div>
        <div class="card-body" style="height: 100%; width: 100%;">
          <canvas id="measurementsChart" style="height: 100%; width: 100%;"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Кнопки навигации -->
  <button class="slider-nav slider-nav-prev" aria-label="Предыдущий график" style="background-color: white; color: black; border: white;">‹</button>
  <button class="slider-nav slider-nav-next" aria-label="Следующий график" style="background-color: white; color: black; border: white;">›</button>
</div>

<!-- Форма ниже -->
<div class="row">
  <div class="col-12 col-lg-6 mb-4 mb-lg-0">
    <div class="card h-100">
      <div class="card-header">Добавить новую запись</div>
      <div class="card-body">
        <form id="progress-form" method="post" action="{% url 'diaries:add_progress' %}">
          {% csrf_token %}
          <div class="mb-3">
            {{ form.date.label_tag }}
            {{ form.date }}
          </div>
          <div class="row g-2">
            <div class="col-12 col-sm-6 mb-3">
              {{ form.weight.label_tag }}
              {{ form.weight }}
            </div>
            <div class="col-12 col-sm-6 mb-3">
              {{ form.energy_level.label_tag }}
              {{ form.energy_level }}
            </div>
          </div>
          <div class="row g-2">
            <div class="col-12 col-md-4 mb-3">
              {{ form.chest.label_tag }}
              {{ form.chest }}
            </div>
            <div class="col-12 col-md-4 mb-3">
              {{ form.waist.label_tag }}
              {{ form.waist }}
            </div>
            <div class="col-12 col-md-4 mb-3">
              {{ form.hips.label_tag }}
              {{ form.hips }}
            </div>
          </div>
          <div class="mb-3">
            {{ form.mood.label_tag }}
            {{ form.mood }}
          </div>
          <div class="mb-3">
            {{ form.notes.label_tag }}
            {{ form.notes }}
          </div>
          <button type="submit" class="btn btn-primary w-100">Сохранить</button>
          <input type="hidden" name="auto_save" value="1">
        </form>
      </div>
    </div>
  </div>
  <div class="col-12 col-lg-6">
    <div class="card h-100">
      <div class="card-header">Последние записи</div>
      <div class="card-body" style="overflow-y: auto; max-height: 500px;">
        {% if recent_records %}
          <div class="list-group">
            {% for record in recent_records %}
              <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-start flex-column flex-sm-row">
                <div class="mb-2 mb-sm-0">
                  <strong>{{ record.date|date:"d.m" }}</strong><br>
                  <small class="d-block">Вес: {% if record.weight %}{{ record.weight }} кг{% else %}-{% endif %}</small>
                  <small class="d-block">Энергия: {% if record.energy_level %}{{ record.energy_level }}/10{% else %}-/10{% endif %}</small>
                  {% if record.mood %}
                    <small class="d-block">Настроение: {{ record.mood }}</small>
                  {% endif %}
                  {% if record.notes %}
                    <small class="d-block">Примечание: {{ record.notes|truncatewords:8 }}</small>
                  {% endif %}
                </div>
                <span class="badge bg-secondary align-self-start align-self-sm-end">{{ record.date|date:"d.m.Y" }}</span>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <p class="text-muted text-center py-4">Нет записей.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Скрипт слайдера и графиков -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const container = document.querySelector('.nutrition-slider-container');
  const slider = document.querySelector('.nutrition-slider');
  const slides = document.querySelectorAll('.nutrition-slide');
  const prevBtn = document.querySelector('.slider-nav-prev');
  const nextBtn = document.querySelector('.slider-nav-next');

  if (!slider || slides.length === 0) return;

  let currentIndex = 0;
  const maxIndex = slides.length - 1;

  // Функция для получения ширины слайда
  function getSlideWidth() {
    return container.offsetWidth;
  }

  function updateSlider() {
    const slideWidth = getSlideWidth();
    const translateX = -currentIndex * slideWidth;
    slider.style.transform = `translateX(${translateX}px)`;

    // Обновляем состояние кнопок
    if (prevBtn) {
      prevBtn.disabled = currentIndex === 0;
      prevBtn.classList.toggle('disabled', currentIndex === 0);
    }

    if (nextBtn) {
      nextBtn.disabled = currentIndex === maxIndex;
      nextBtn.classList.toggle('disabled', currentIndex === maxIndex);
    }
  }

  function updateActiveSlides() {
    slides.forEach((slide, index) => {
      slide.classList.remove('active');
      if (index === currentIndex) {
        slide.classList.add('active');
      }
    });
  }

  // Навигация кнопками
  prevBtn?.addEventListener('click', () => {
    if (currentIndex > 0) {
      currentIndex--;
      updateSlider();
      updateActiveSlides();
    }
  });

  nextBtn?.addEventListener('click', () => {
    if (currentIndex < maxIndex) {
      currentIndex++;
      updateSlider();
      updateActiveSlides();
    }
  });

  // Колесико мыши
  let scrollTimeout;
  container.addEventListener('wheel', (e) => {
    e.preventDefault();
    clearTimeout(scrollTimeout);
    const direction = e.deltaY > 0 ? 1 : -1;
    if (direction > 0 && currentIndex < maxIndex) {
      currentIndex++;
    } else if (direction < 0 && currentIndex > 0) {
      currentIndex--;
    }
    updateSlider();
    updateActiveSlides();
    scrollTimeout = setTimeout(() => {}, 150);
  }, { passive: false });

  // Drag & Touch
  let isDragging = false;
  let startX = 0;
  let startTranslate = 0;
  let currentTranslate = 0;
  let animationID = null;

  function startDrag(e) {
    isDragging = true;
    startX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
    startTranslate = -currentIndex * getSlideWidth();
    slider.style.transition = 'none';

    if (animationID) {
      cancelAnimationFrame(animationID);
      animationID = null;
    }
  }

  function drag(e) {
    if (!isDragging) return;

    const currentX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
    const diff = currentX - startX;
    currentTranslate = startTranslate + diff;

    slider.style.transform = `translateX(${currentTranslate}px)`;
  }

  function endDrag() {
    if (!isDragging) return;
    isDragging = false;

    const slideWidth = getSlideWidth();
    const movedBy = currentTranslate + (currentIndex * slideWidth);

    if (Math.abs(movedBy) > slideWidth * 0.2) {
      if (movedBy > 0 && currentIndex > 0) {
        currentIndex--;
      } else if (movedBy < 0 && currentIndex < maxIndex) {
        currentIndex++;
      }
    }

    slider.style.transition = 'transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
    updateSlider();
    updateActiveSlides();
  }

  // Мышь
  container.addEventListener('mousedown', startDrag);
  container.addEventListener('mousemove', drag);
  container.addEventListener('mouseup', endDrag);
  container.addEventListener('mouseleave', endDrag);

  // Touch
  container.addEventListener('touchstart', startDrag);
  container.addEventListener('touchmove', drag);
  container.addEventListener('touchend', endDrag);
  container.addEventListener('touchcancel', endDrag);

  // Ресайз окна
  let resizeTimeout;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(() => {
      updateSlider();
    }, 250);
  });

  // Инициализация
  updateSlider();
  updateActiveSlides();

  // Графики
  const weightCtx = document.getElementById('weightChart').getContext('2d');
  new Chart(weightCtx, {
    type: 'line',
    data: {
      labels: {{ chart_dates|safe }},
      datasets: [{
        label: 'Вес (кг)',
        data: {{ chart_weights|safe }},
        borderColor: '#9BC1BC',
        backgroundColor: 'rgba(155, 193, 188, 0.1)',
        borderWidth: 3,
        tension: 0.3,
        fill: true,
        pointBackgroundColor: '#9BC1BC',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointRadius: 5,
        pointHoverRadius: 7
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false, // Изменено на false для лучшего контроля
      plugins: {
        legend: {
          display: false
        }
      },
      scales: {
        x: {
          ticks: {
            color: '#666666',
            font: {
              size: 13,
              family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
              weight: '500'
            },
            maxRotation: 45,
            minRotation: 45,
            callback: function(value, index, values) {
              const date = new Date(this.getLabelForValue(value));
              const day = String(date.getDate()).padStart(2, '0');
              const month = ['янв', 'фев', 'мар', 'апр', 'май', 'июн', 'июл', 'авг', 'сен', 'окт', 'ноя', 'дек'][date.getMonth()];
              const dayName = ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'][date.getDay()];
              return `${day} ${month} (${dayName})`;
            }
          },
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          }
        },
        y: {
          beginAtZero: false,
          ticks: {
            color: '#666666',
            font: {
              size: 12
            }
          },
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          }
        }
      }
    }
  });

  const measureCtx = document.getElementById('measurementsChart').getContext('2d');
  new Chart(measureCtx, {
    type: 'line',
    data: {
      labels: {{ chart_dates|safe }},
      datasets: [
        {
          label: 'Грудь',
          data: {{ chart_chest|safe }},
          borderColor: '#D4A5A5',
          backgroundColor: 'rgba(212, 165, 165, 0.1)',
          borderWidth: 3,
          tension: 0.3,
          fill: true,
          pointBackgroundColor: '#D4A5A5',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          pointRadius: 5,
          pointHoverRadius: 7
        },
        {
          label: 'Талия',
          data: {{ chart_waist|safe }},
          borderColor: '#A5C4D4',
          backgroundColor: 'rgba(165, 196, 212, 0.1)',
          borderWidth: 3,
          tension: 0.3,
          fill: true,
          pointBackgroundColor: '#A5C4D4',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          pointRadius: 5,
          pointHoverRadius: 7
        },
        {
          label: 'Бёдра',
          data: {{ chart_hips|safe }},
          borderColor: '#C8B8DB',
          backgroundColor: 'rgba(200, 184, 219, 0.1)',
          borderWidth: 3,
          tension: 0.3,
          fill: true,
          pointBackgroundColor: '#C8B8DB',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          pointRadius: 5,
          pointHoverRadius: 7
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false, // Изменено на false для лучшего контроля
      plugins: {
        legend: {
          display: true,
          position: 'top',
          labels: {
            color: '#333333',
            font: {
              size: 13,
              family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
            },
            padding: 15,
            usePointStyle: true,
            pointStyle: 'circle'
          }
        }
      },
      scales: {
        x: {
          ticks: {
            color: '#666666',
            font: {
              size: 13,
              family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif",
              weight: '500'
            },
            maxRotation: 45,
            minRotation: 45,
            callback: function(value, index, values) {
              const date = new Date(this.getLabelForValue(value));
              const day = String(date.getDate()).padStart(2, '0');
              const month = ['янв', 'фев', 'мар', 'апр', 'май', 'июн', 'июл', 'авг', 'сен', 'окт', 'ноя', 'дек'][date.getMonth()];
              const dayName = ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'][date.getDay()];
              return `${day} ${month} (${dayName})`;
            }
          },
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          }
        },
        y: {
          beginAtZero: false,
          ticks: {
            color: '#666666',
            font: {
              size: 12
            }
          },
          grid: {
            color: 'rgba(0, 0, 0, 0.05)'
          }
        }
      },
      interaction: {
        intersect: false,
        mode: 'index'
      }
    }
  });
});

const form = document.getElementById('progress-form');
if (form) {
  let debounceTimer;
  const inputs = form.querySelectorAll('input, textarea, select');
  inputs.forEach(input => {
    input.addEventListener('input', () => {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        const formData = new FormData(form);
        fetch(form.action, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            console.log('Данные автоматически сохранены');
          }
        });
      }, 1000);
    });
  });
}
</script>

<style>
/* Базовые стили слайдера - ИСПРАВЛЕНЫ */
.nutrition-slider-container {
  position: relative;
  overflow: hidden;
  margin: 1.5rem 0;
  cursor: grab;
  height: 50vh;
  min-height: 450px;
  max-height: 700px;
  background: white;
  border-radius: 1rem;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
  -webkit-tap-highlight-color: transparent;
  width: 100%;
}

.nutrition-slider-container:active {
  cursor: grabbing;
}

.nutrition-slider {
  display: flex;
  transition: transform 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  width: 100%;
  height: 100%;
  will-change: transform;
}

.nutrition-slide {
  flex: 0 0 100%;
  min-width: 100%;
  height: 100%;
  opacity: 0.4;
  transform: scale(0.95);
  transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 10px;
  box-sizing: border-box;
}

.nutrition-slide.active {
  opacity: 1;
  transform: scale(1);
  box-shadow: 0 8px 32px rgba(106, 156, 137, 0.25);
}

/* Стили для карточек с графиками */
.nutrition-slide .card {
  height: 90%;
  width: 95%;
  margin: 0;
  border: 1px solid #e9ecef;
  border-radius: 0.75rem;
  background: white;
  display: flex;
  flex-direction: column;
  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  position: relative;
}

.nutrition-slide .card-header {
  background: white;
  border-bottom: 1px solid #e9ecef;
  color: #2c3e50;
  font-weight: 600;
  font-size: 1.1rem;
  padding: 1rem 1.5rem;
  text-align: center;
  flex-shrink: 0;
}

.nutrition-slide .card-body {
  flex: 1;
  padding: 1.5rem;
  display: flex;
  align-items: center;
  justify-content: center;
  position: relative;
  overflow: hidden;
  min-height: 0; /* Важно для flex-контейнеров */
}

.nutrition-slide .card-body canvas {
  display: block;
  width: 100% !important;
  height: 100% !important;
  max-width: 100%;
  max-height: 100%;
}

.slider-nav {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: white;
  color: #6a9c89;
  border: 2px solid #6a9c89;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  font-size: 1.5rem;
  cursor: pointer;
  z-index: 10;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  transition: all 0.2s ease;
  opacity: 0.9;
  user-select: none;
}

.slider-nav:hover:not(.disabled) {
  transform: translateY(-50%) scale(1.1);
  background: #6a9c89;
  color: white;
  opacity: 1;
}

.slider-nav.disabled {
  opacity: 0.3;
  cursor: not-allowed;
  border-color: #ccc;
  color: #ccc;
  pointer-events: none;
}

.slider-nav-prev {
  left: 1.5rem;
}

.slider-nav-next {
  right: 1.5rem;
}

/* Адаптивные стили для разных устройств */

/* Большие планшеты и маленькие десктопы (992px - 1200px) */
@media (max-width: 1200px) {
  .nutrition-slider-container {
    height: 45vh;
    min-height: 420px;
    max-height: 600px;
  }

  .nutrition-slide .card {
    width: 94%;
    height: 88%;
  }

  .nutrition-slide .card-header {
    font-size: 1.05rem;
    padding: 0.9rem 1.2rem;
  }

  .nutrition-slide .card-body {
    padding: 1.2rem;
  }
}

/* Планшеты (768px - 992px) */
@media (max-width: 992px) {
  .nutrition-slider-container {
    height: 50vh;
    min-height: 380px;
    max-height: 500px;
    border-radius: 0.875rem;
    margin: 1.25rem 0;
  }

  .nutrition-slide .card {
    width: 92%;
    height: 85%;
    border-radius: 0.625rem;
  }

  .nutrition-slide .card-header {
    font-size: 1rem;
    padding: 0.8rem 1rem;
  }

  .nutrition-slide .card-body {
    padding: 1rem;
  }

  .slider-nav {
    width: 44px;
    height: 44px;
    font-size: 1.3rem;
  }

  .slider-nav-prev {
    left: 1rem;
  }

  .slider-nav-next {
    right: 1rem;
  }
}

/* Большие телефоны (576px - 768px) */
@media (max-width: 768px) {
  .nutrition-slider-container {
    height: 55vh;
    min-height: 350px;
    max-height: 450px;
    border-radius: 0.75rem;
    margin: 1rem 0;
  }

  .nutrition-slide {
    padding: 8px;
  }

  .nutrition-slide .card {
    width: 90%;
    height: 82%;
    border-radius: 0.5rem;
  }

  .nutrition-slide .card-header {
    font-size: 0.95rem;
    padding: 0.7rem 0.9rem;
  }

  .nutrition-slide .card-body {
    padding: 0.8rem;
  }

  .slider-nav {
    width: 40px;
    height: 40px;
    font-size: 1.2rem;
    border-width: 1.5px;
  }

  .slider-nav-prev {
    left: 0.75rem;
  }

  .slider-nav-next {
    right: 0.75rem;
  }
}

/* Маленькие телефоны (400px - 576px) */
@media (max-width: 576px) {
  .nutrition-slider-container {
    height: 60vh;
    min-height: 320px;
    max-height: 400px;
    border-radius: 0.625rem;
  }

  .nutrition-slide {
    padding: 5px;
  }

  .nutrition-slide .card {
    width: 88%;
    height: 80%;
    border-radius: 0.375rem;
  }

  .nutrition-slide .card-header {
    font-size: 0.9rem;
    padding: 0.6rem 0.8rem;
  }

  .nutrition-slide .card-body {
    padding: 0.6rem;
  }

  .slider-nav {
    width: 36px;
    height: 36px;
    font-size: 1.1rem;
    border-width: 1px;
  }

  .slider-nav-prev {
    left: 0.5rem;
  }

  .slider-nav-next {
    right: 0.5rem;
  }
}

/* Очень маленькие телефоны (до 400px) */
@media (max-width: 400px) {
  .nutrition-slider-container {
    height: 65vh;
    min-height: 300px;
    max-height: 380px;
    border-radius: 0.5rem;
  }

  .nutrition-slide .card {
    width: 86%;
    height: 78%;
    border-radius: 0.25rem;
  }

  .nutrition-slide .card-header {
    font-size: 0.85rem;
    padding: 0.5rem 0.7rem;
  }

  .nutrition-slide .card-body {
    padding: 0.5rem;
  }

  .slider-nav {
    width: 32px;
    height: 32px;
    font-size: 1rem;
  }

  .slider-nav-prev {
    left: 0.35rem;
  }

  .slider-nav-next {
    right: 0.35rem;
  }
}

/* Ландшафтная ориентация на мобильных */
@media (max-height: 500px) and (orientation: landscape) {
  .nutrition-slider-container {
    height: 70vh;
    min-height: 280px;
    max-height: 350px;
  }

  .nutrition-slide .card {
    height: 75%;
  }
}

/* Высокие экраны (более 1200px) */
@media (min-width: 1400px) {
  .nutrition-slider-container {
    max-height: 750px;
  }

  .nutrition-slide .card {
    width: 96%;
    height: 92%;
  }
}

/* Стили для темной темы */
@media (prefers-color-scheme: dark) {
  .nutrition-slider-container {
    background-color: #2d2d2d;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
  }

  .nutrition-slide .card {
    background-color: #1e1e1e;
    border-color: #444;
  }

  .nutrition-slide .card-header {
    background-color: #2d2d2d;
    border-bottom-color: #444;
    color: #fff;
  }

  .slider-nav {
    background: #2d2d2d;
    border-color: #6a9c89;
    color: #6a9c89;
  }

  .slider-nav:hover:not(.disabled) {
    background: #6a9c89;
    color: #2d2d2d;
  }
}

/* Отключаем анимации для пользователей, которые их предпочитают не использовать */
@media (prefers-reduced-motion: reduce) {
  .nutrition-slider,
  .nutrition-slide,
  .slider-nav {
    transition: none !important;
  }
}

/* Улучшаем доступность для фокуса */
.slider-nav:focus {
  outline: 3px solid #6a9c89;
  outline-offset: 2px;
}
</style>

{% endblock %}