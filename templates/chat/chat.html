<!-- templates/chat/chat.html -->
{% extends 'accounts/base_dashboard.html' %}

{% block title %}–ß–∞—Ç ‚Äî {{ recipient.get_full_name|default:recipient.email }}{% endblock %}

{% block content %}
<div class="chat-container" style="max-width: 800px; margin: 0 auto;">
  <h2><i class="bi bi-chat-dots me-2"></i>–ß–∞—Ç —Å {{ recipient.get_full_name|default:recipient.email }}</h2>

  <div id="messages" style="
    height: 400px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    padding: 1rem;
    margin-bottom: 1rem;
    background: #f8f9fa;
    display: flex;
    flex-direction: column;
  ">
    {% if messages %}
      {% for msg in messages %}
        {% if msg.sender_id == user_id_str %}
          <div class="d-flex flex-column mb-3 align-items-end">
            <div class="message-bubble sent" data-message-id="{{ msg.id }}">
              <small class="text-muted d-block mb-1">{{ msg.timestamp }}</small>
              <div class="message-text">{{ msg.text|default:"‚Äî" }}</div>
            </div>
            <div class="message-actions mt-1" style="font-size: 0.8rem;">
              <a href="#" class="edit-btn text-muted me-2">‚úé –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
              <a href="#" class="delete-btn text-muted">üóë –£–¥–∞–ª–∏—Ç—å</a>
            </div>
          </div>
        {% else %}
          <div class="d-flex flex-column mb-3 align-items-start">
            <div class="message-bubble received">
              <small class="text-muted d-block mb-1">{{ msg.timestamp }}</small>
              <div class="message-text">{{ msg.text|default:"‚Äî" }}</div>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    {% else %}
      <p class="text-muted text-center py-4">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π.</p>
    {% endif %}
  </div>

  <form id="message-form">
    {% csrf_token %}
    <input type="hidden" id="recipient-id" value="{{ recipient.id }}">
    <div class="input-group">
      <input type="text" id="message-input" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." required>
      <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </form>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è -->
<div id="deleteModal" style="
  display: none;
  position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
  justify-content: center;
  align-items: center;
">
  <div style="
    background: white;
    padding: 1.5rem;
    border-radius: 8px;
    max-width: 300px;
    text-align: center;
  ">
    <p>–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?</p>
    <button id="confirmDeleteYes" class="btn btn-danger btn-sm me-2">–î–∞</button>
    <button id="confirmDeleteNo" class="btn btn-secondary btn-sm">–ù–µ—Ç</button>
  </div>
</div>

<style>
  .message-bubble {
    max-width: 80%;
    padding: 0.75rem 1rem;
    border-radius: 16px;
    font-size: 0.95rem;
    line-height: 1.4;
    word-break: break-word;
  }
  .sent {
    background: #e8f5e9;
    border-bottom-right-radius: 4px;
    text-align: right;
  }
  .received {
    background: #f1f3f5;
    border-bottom-left-radius: 4px;
    text-align: left;
  }
  .message-actions a {
    text-decoration: none;
    cursor: pointer;
    font-size: 0.85rem;
  }
  .message-actions a:hover {
    text-decoration: underline;
  }
  .edit-input {
    width: 100%;
    padding: 0.25rem;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 0.95rem;
    box-sizing: border-box;
  }
</style>

<script>
let ws;
const messagesContainer = document.getElementById('messages');
const messageInput = document.getElementById('message-input');
const form = document.getElementById('message-form');
const deleteModal = document.getElementById('deleteModal');
let currentMessageIdForDelete = null;

function connectWebSocket() {
    const roomName = '{{ recipient.id }}';
    const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const wsUrl = `${protocol}://${window.location.host}/ws/chat/${roomName}/`;

    ws = new WebSocket(wsUrl);

    ws.onopen = function(e) {
        console.log('‚úÖ WebSocket connected');
    };

    ws.onmessage = function(e) {
        const data = JSON.parse(e.data);
        if (data.type === 'edit_message') {
            const bubble = document.querySelector(`[data-message-id="${data.message_id}"]`);
            if (!bubble) return;
            const container = bubble.querySelector('.message-text, .edit-input');
            if (!container) return;
            const newTextDiv = document.createElement('div');
            newTextDiv.className = 'message-text';
            newTextDiv.textContent = data.new_text;
            container.replaceWith(newTextDiv);
        } else if (data.type === 'delete_message') {
            const wrapper = document.querySelector(`[data-message-id="${data.message_id}"]`)?.closest('.d-flex');
            if (wrapper) wrapper.remove();
        } else if (data.type === 'new_message') {
            if (data.message_id && document.querySelector(`[data-message-id="${data.message_id}"]`)) return;
            addMessageToChat(data.message, data.sender_id, data.timestamp, data.message_id);
            scrollToBottom();
        }
    };

    ws.onclose = function(e) {
        setTimeout(connectWebSocket, 1000);
    };
}

function addMessageToChat(text, senderId, timestamp, messageId = null) {
    const isSent = senderId === "{{ user.id }}";
    const wrapper = document.createElement('div');
    wrapper.className = `d-flex flex-column mb-3 ${isSent ? 'align-items-end' : 'align-items-start'}`;

    let bubbleHtml = `
        <div class="message-bubble ${isSent ? 'sent' : 'received'}"
             ${messageId ? `data-message-id="${messageId}"` : ''}>
            <small class="text-muted d-block mb-1">${timestamp}</small>
            <div class="message-text">${text}</div>
        </div>
    `;
    wrapper.innerHTML = bubbleHtml;

    if (isSent && messageId) {
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'message-actions mt-1';
        actionsDiv.style.fontSize = '0.8rem';
        actionsDiv.innerHTML = `
            <a href="#" class="edit-btn text-muted me-2">‚úé –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
            <a href="#" class="delete-btn text-muted">üóë –£–¥–∞–ª–∏—Ç—å</a>
        `;
        wrapper.appendChild(actionsDiv);
    }

    messagesContainer.appendChild(wrapper);
}

function scrollToBottom() {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('edit-btn')) {
        const wrapper = e.target.closest('.d-flex');
        const bubble = wrapper.querySelector('.message-bubble');
        const textEl = bubble.querySelector('.message-text');
        const messageId = bubble.dataset.messageId;
        if (!messageId || !textEl) return;

        const currentText = textEl.textContent;
        const input = document.createElement('input');
        input.type = 'text';
        input.value = currentText;
        input.className = 'edit-input';
        input.dataset.original = currentText;

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ Enter
        input.addEventListener('keydown', function(ev) {
            if (ev.key === 'Enter') {
                saveEdit(messageId, input.value.trim(), input);
            }
        });

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞
        input.addEventListener('blur', function() {
            saveEdit(messageId, input.value.trim(), input);
        });

        textEl.replaceWith(input);
        input.select();
    }

    if (e.target.classList.contains('delete-btn')) {
        const bubble = e.target.closest('.d-flex').querySelector('.message-bubble');
        currentMessageIdForDelete = bubble.dataset.messageId;
        deleteModal.style.display = 'flex';
    }
});

function saveEdit(messageId, newText, inputElement) {
    const originalText = inputElement.dataset.original || '';
    if (newText && newText !== originalText) {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        ws.send(JSON.stringify({
            'action': 'edit_message',
            'message_id': messageId,
            'text': newText
        }));
    }
    // –í –ª—é–±–æ–º —Å–ª—É—á–∞–µ ‚Äî –∑–∞–º–µ–Ω—è–µ–º input –Ω–∞ div
    const newTextDiv = document.createElement('div');
    newTextDiv.className = 'message-text';
    newTextDiv.textContent = newText || originalText;
    inputElement.replaceWith(newTextDiv);
}

// –£–¥–∞–ª–µ–Ω–∏–µ
document.getElementById('confirmDeleteYes').addEventListener('click', function() {
    if (currentMessageIdForDelete) {
        ws.send(JSON.stringify({
            'action': 'delete_message',
            'message_id': currentMessageIdForDelete
        }));
    }
    deleteModal.style.display = 'none';
    currentMessageIdForDelete = null;
});

document.getElementById('confirmDeleteNo').addEventListener('click', function() {
    deleteModal.style.display = 'none';
    currentMessageIdForDelete = null;
});

// –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
form.addEventListener('submit', function(e) {
    e.preventDefault();
    const text = messageInput.value.trim();
    if (!text) return;
    ws.send(JSON.stringify({ 'message': text }));
    messageInput.value = '';
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', function() {
    connectWebSocket();
    scrollToBottom();
});
</script>
{% endblock %}