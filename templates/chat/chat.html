<!-- templates/chat/chat.html -->
{% extends 'accounts/base_dashboard.html' %}

{% block title %}Чат — {{ recipient.get_full_name|default:recipient.email }}{% endblock %}

{% block content %}


<div class="chat-container" style="max-width: 800px; margin: 0 auto;">
  <h2><i class="bi bi-chat-dots me-2"></i>Чат с {{ recipient.get_full_name|default:recipient.email }}</h2>

<div id="messages" style="
  height: 400px;
  overflow-y: auto;
  border: 1px solid #dee2e6;
  padding: 1rem;
  margin-bottom: 1rem;
  background: #f8f9fa;
">
  {% if messages %}
    {% for msg in messages %}
      {% if msg.sender_id == user_id_str %}
        <!-- Твои сообщения -->
        <div class="d-flex mb-3 justify-content-end">
          <div class="message-bubble sent">
            <small class="text-muted d-block mb-1">{{ msg.timestamp }}</small>
            <div>{{ msg.text|default:"—" }}</div>
          </div>
        </div>
      {% else %}
        <!-- Сообщения собеседника -->
        <div class="d-flex mb-3 justify-content-start">
          <div class="message-bubble received">
            <small class="text-muted d-block mb-1">{{ msg.timestamp }}</small>
            <div>{{ msg.text|default:"—" }}</div>
          </div>
        </div>
      {% endif %}
    {% endfor %}
  {% else %}
    <p class="text-muted text-center py-4">Нет сообщений.</p>
  {% endif %}
</div>

  <form id="message-form">
    {% csrf_token %}
    <input type="hidden" id="recipient-id" value="{{ recipient.id }}">
    <div class="input-group">
      <input type="text" id="message-input" class="form-control" placeholder="Введите сообщение..." required>
      <button type="submit" class="btn btn-primary">Отправить</button>
    </div>
  </form>
</div>

<style>
  .message-bubble {
    max-width: 80%;
    padding: 0.75rem 1rem;
    border-radius: 16px;
    font-size: 0.95rem;
    line-height: 1.4;
    word-break: break-word;
  }
  .sent {
    background: #e8f5e9; /* нежно-зелёный */
    border-bottom-right-radius: 4px;
    text-align: right;
    margin-left: auto;
  }
  .received {
    background: #f1f3f5; /* светло-серый */
    border-bottom-left-radius: 4px;
    text-align: left;
    margin-right: auto;
  }
  #messages {
    height: 400px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    padding: 1rem;
    margin-bottom: 1rem;
    background: #f8f9fa;
    display: flex;
    flex-direction: column;
  }
</style>

<script>
let ws;
const messagesContainer = document.getElementById('messages');
const messageInput = document.getElementById('message-input');
const form = document.getElementById('message-form');

function connectWebSocket() {
    const roomName = '{{ recipient.id }}';
    const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const wsUrl = `${protocol}://${window.location.host}/ws/chat/${roomName}/`;

    ws = new WebSocket(wsUrl);

    ws.onopen = function(e) {
        console.log('✅ WebSocket connected');
    };

    ws.onmessage = function(e) {
        const data = JSON.parse(e.data);
        addMessageToChat(data.message, data.sender_id, data.timestamp || 'только что');
        scrollToBottom();
    };

    ws.onclose = function(e) {
        console.log('⚠️ WebSocket disconnected. Reconnecting in 1s...');
        setTimeout(connectWebSocket, 1000);
    };

    ws.onerror = function(err) {
        console.error('❌ WebSocket error:', err);
    };
}

function addMessageToChat(text, senderId, timestamp) {
    const isSent = senderId === "{{ user.id }}";
    const messageEl = document.createElement('div');
    messageEl.className = `d-flex mb-3 ${isSent ? 'justify-content-end' : 'justify-content-start'}`;
    messageEl.innerHTML = `
        <div class="message-bubble ${isSent ? 'sent' : 'received'}">
            <small class="text-muted d-block mb-1">${timestamp}</small>
            <div>${text}</div>
        </div>
    `;
    messagesContainer.appendChild(messageEl);
}

function scrollToBottom() {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Отправка сообщения
form.addEventListener('submit', function(e) {
    e.preventDefault();
    const text = messageInput.value.trim();
    if (!text) return;

    // Отправляем через WebSocket
    ws.send(JSON.stringify({
        'message': text
    }));

    // Очищаем поле
    messageInput.value = '';
});

// Подключаемся при загрузке
document.addEventListener('DOMContentLoaded', function() {
    connectWebSocket();
    scrollToBottom();
});
</script>
{% endblock %}