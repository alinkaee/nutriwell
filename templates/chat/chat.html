<!-- templates/chat/chat.html -->
{% extends 'accounts/base_dashboard.html' %}

{% block title %}–ß–∞—Ç ‚Äî {{ recipient.get_full_name|default:recipient.email }}{% endblock %}

{% block content %}
<div class="chat-container" style="max-width: 800px; margin: 0 auto;">
  <h2><i class="bi bi-chat-dots me-2"></i>–ß–∞—Ç —Å {{ recipient.get_full_name|default:recipient.email }}</h2>

  <div id="messages" style="
    height: 400px;
    overflow-y: auto;
    border: 1px solid #dee2e6;
    padding: 1rem;
    margin-bottom: 1rem;
    background: #f8f9fa;
    display: flex;
    flex-direction: column;
  ">
    {% if messages %}
      {% for msg in messages %}
        {% if msg.sender_id == user_id_str %}
          <div class="d-flex mb-3 justify-content-end">
            <div class="message-bubble sent" data-message-id="{{ msg.id }}">
              <small class="text-muted d-block mb-1">{{ msg.timestamp }}</small>
              <div>{{ msg.text|default:"‚Äî" }}</div>
            </div>
          </div>
          <div class="d-flex justify-content-end mb-3">
            <div class="message-actions" style="font-size: 0.8rem;">
              <a href="#" class="edit-btn text-muted me-2">‚úé –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
              <a href="#" class="delete-btn text-muted">üóë –£–¥–∞–ª–∏—Ç—å</a>
            </div>
          </div>
        {% else %}
          <div class="d-flex mb-3 justify-content-start">
            <div class="message-bubble received">
              <small class="text-muted d-block mb-1">{{ msg.timestamp }}</small>
              <div>{{ msg.text|default:"‚Äî" }}</div>
            </div>
          </div>
        {% endif %}
      {% endfor %}
    {% else %}
      <p class="text-muted text-center py-4">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π.</p>
    {% endif %}
  </div>

  <form id="message-form">
    {% csrf_token %}
    <input type="hidden" id="recipient-id" value="{{ recipient.id }}">
    <div class="input-group">
      <input type="text" id="message-input" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." required>
      <button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
  </form>
</div>

<style>
  .message-bubble {
    max-width: 80%;
    padding: 0.75rem 1rem;
    border-radius: 16px;
    font-size: 0.95rem;
    line-height: 1.4;
    word-break: break-word;
  }
  .sent {
    background: #e8f5e9;
    border-bottom-right-radius: 4px;
    text-align: right;
    margin-left: auto;
  }
  .received {
    background: #f1f3f5;
    border-bottom-left-radius: 4px;
    text-align: left;
    margin-right: auto;
  }
  .message-actions {
    margin-top: -0.5rem;
    margin-bottom: 0.5rem;
  }
  .message-actions a {
    text-decoration: none;
    cursor: pointer;
  }
  .message-actions a:hover {
    text-decoration: underline;
  }
</style>

<script>
let ws;
const messagesContainer = document.getElementById('messages');
const messageInput = document.getElementById('message-input');
const form = document.getElementById('message-form');

function connectWebSocket() {
    const roomName = '{{ recipient.id }}';
    const protocol = window.location.protocol === 'https:' ? 'wss' : 'ws';
    const wsUrl = `${protocol}://${window.location.host}/ws/chat/${roomName}/`;

    ws = new WebSocket(wsUrl);

    ws.onopen = function(e) {
        console.log('‚úÖ WebSocket connected');
    };

    ws.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log('üì• –ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:', data);

        if (data.type === 'edit_message') {
            const el = document.querySelector(`[data-message-id="${data.message_id}"] div:not(.message-actions)`);
            if (el) {
                el.textContent = data.new_text + ' (–∏–∑–º–µ–Ω–µ–Ω–æ)';
                console.log('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–æ:', data.message_id);
            } else {
                console.warn('‚ö†Ô∏è –≠–ª–µ–º–µ–Ω—Ç –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω:', data.message_id);
            }
            return;
        }

        if (data.type === 'delete_message') {
            const bubble = document.querySelector(`[data-message-id="${data.message_id}"]`);
            const actions = bubble ? bubble.nextElementSibling : null;
            if (bubble) {
                bubble.remove();
                if (actions && actions.classList.contains('message-actions')) {
                    actions.remove();
                }
                console.log('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ:', data.message_id);
            } else {
                console.warn('‚ö†Ô∏è –≠–ª–µ–º–µ–Ω—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω:', data.message_id);
            }
            return;
        }

        if (data.type === 'new_message') {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥—É–±–ª–∏
            if (data.message_id && document.querySelector(`[data-message-id="${data.message_id}"]`)) {
                console.log('‚ÑπÔ∏è –°–æ–æ–±—â–µ–Ω–∏–µ —É–∂–µ –µ—Å—Ç—å, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º:', data.message_id);
                return;
            }
            addMessageToChat(data.message, data.sender_id, data.timestamp, data.message_id);
            scrollToBottom();
            return;
        }
    };

    ws.onclose = function(e) {
        console.log('‚ö†Ô∏è WebSocket disconnected. Reconnecting in 1s...');
        setTimeout(connectWebSocket, 1000);
    };

    ws.onerror = function(err) {
        console.error('‚ùå WebSocket error:', err);
    };
}

function addMessageToChat(text, senderId, timestamp, messageId = null) {
    console.log('‚ûï –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ:', { text, senderId, timestamp, messageId });
    const isSent = senderId === "{{ user.id }}";

    // –°–æ–∑–¥–∞—ë–º –û–î–ù–£ –æ–±—ë—Ä—Ç–∫—É
    const wrapper = document.createElement('div');
    wrapper.className = `d-flex flex-column mb-3 ${isSent ? 'align-items-end' : 'align-items-start'}`;

    let bubbleHtml = `
        <div class="message-bubble ${isSent ? 'sent' : 'received'}"
             ${messageId ? `data-message-id="${messageId}"` : ''}>
            <small class="text-muted d-block mb-1">${timestamp}</small>
            <div>${text}</div>
        </div>
    `;
    wrapper.innerHTML = bubbleHtml;

    // –ï—Å–ª–∏ —Å–≤–æ–∏ –∏ –µ—Å—Ç—å ID ‚Äî –¥–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ –í–ù–£–¢–†–¨ —ç—Ç–æ–π –∂–µ –æ–±—ë—Ä—Ç–∫–∏
    if (isSent && messageId) {
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'message-actions mt-1';
        actionsDiv.style.fontSize = '0.8rem';
        actionsDiv.innerHTML = `
            <a href="#" class="edit-btn text-muted me-2">‚úé –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
            <a href="#" class="delete-btn text-muted">üóë –£–¥–∞–ª–∏—Ç—å</a>
        `;
        wrapper.appendChild(actionsDiv);
    }

    messagesContainer.appendChild(wrapper);
    console.log('‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ —Å –∫–Ω–æ–ø–∫–∞–º–∏ (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ)');
}

function scrollToBottom() {
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

form.addEventListener('submit', function(e) {
    e.preventDefault();
    const text = messageInput.value.trim();
    if (!text) return;

    ws.send(JSON.stringify({
        'message': text
    }));
    console.log('üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:', text);
    messageInput.value = '';
});

document.addEventListener('click', function(e) {
    if (e.target.classList.contains('edit-btn') || e.target.classList.contains('delete-btn')) {
        // –ò—â–µ–º –æ–±—ë—Ä—Ç–∫—É (.d-flex), —Å–æ–¥–µ—Ä–∂–∞—â—É—é –∏ bubble, –∏ –∫–Ω–æ–ø–∫–∏
        const wrapper = e.target.closest('.d-flex');
        if (!wrapper) {
            console.warn('‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω–∞ –æ–±—ë—Ä—Ç–∫–∞ .d-flex');
            return;
        }

        const bubble = wrapper.querySelector('.message-bubble');
        if (!bubble) {
            console.warn('‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω .message-bubble –≤ –æ–±—ë—Ä—Ç–∫–µ');
            return;
        }

        const messageId = bubble.dataset.messageId;
        if (!messageId) {
            console.warn('‚ö†Ô∏è –£ —Å–æ–æ–±—â–µ–Ω–∏—è –Ω–µ—Ç data-message-id');
            return;
        }

        if (e.target.classList.contains('edit-btn')) {
            const textEl = bubble.querySelector('div:not(.message-actions)');
            const currentText = textEl.textContent.replace(' (–∏–∑–º–µ–Ω–µ–Ω–æ)', '');
            const newText = prompt('–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ:', currentText);

            if (newText && newText.trim() && newText.trim() !== currentText) {
                ws.send(JSON.stringify({
                    'action': 'edit_message',
                    'message_id': messageId,
                    'text': newText.trim()
                }));
                console.log('üì§ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:', messageId);
            }
        }

        if (e.target.classList.contains('delete-btn')) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
                ws.send(JSON.stringify({
                    'action': 'delete_message',
                    'message_id': messageId
                }));
                console.log('üì§ –£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ:', messageId);
            }
        }
    }
});

document.addEventListener('DOMContentLoaded', function() {
    connectWebSocket();
    scrollToBottom();
});
</script>
{% endblock %}