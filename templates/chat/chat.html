<!-- templates/chat/chat.html -->
{% extends 'accounts/base_dashboard.html' %}

{% block title %}Чат — {{ recipient.get_full_name|default:recipient.email }}{% endblock %}

{% block content %}
<style>
  .message-bubble {
    max-width: 80%;
    padding: 0.75rem 1rem;
    border-radius: 16px;
    font-size: 0.95rem;
    line-height: 1.5;
  }

  .message-bubble.sent {
    background: #e8f5e9; /* нежно-зелёный */
    border-bottom-right-radius: 4px;
    text-align: right;
  }

  .message-bubble.received {
    background: #f1f3f5; /* светло-серый */
    border-bottom-left-radius: 4px;
    text-align: left;
  }

  /* Для мобильных — чтобы не вылезало за экран */
  @media (max-width: 768px) {
    .message-bubble {
      max-width: 90%;
    }
  }
</style>

<div class="chat-container" style="max-width: 800px; margin: 0 auto;">
  <h2><i class="bi bi-chat-dots me-2"></i>Чат с {{ recipient.get_full_name|default:recipient.email }}</h2>

<div id="messages" style="
  height: 400px;
  overflow-y: auto;
  border: 1px solid #dee2e6;
  padding: 1rem;
  margin-bottom: 1rem;
  background: #f8f9fa;
">
  {% if messages %}
    {% for msg in messages %}
      <div class="d-flex mb-3 {% if msg.sender_id == user.id %}justify-content-end{% else %}justify-content-start{% endif %}">
        <div class="message-bubble {% if msg.sender_id == user.id %}sent{% else %}received{% endif %}">
          <small class="text-muted d-block mb-1">{{ msg.timestamp }}</small>
          <div>{{ msg.text|default:"—" }}</div>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <p class="text-muted text-center py-4">Нет сообщений.</p>
  {% endif %}
</div>

  <form id="message-form">
    {% csrf_token %}
    <input type="hidden" id="recipient-id" value="{{ recipient.id }}">
    <div class="input-group">
      <input type="text" id="message-input" class="form-control" placeholder="Введите сообщение..." required>
      <button type="submit" class="btn btn-primary">Отправить</button>
    </div>
  </form>
</div>

<script>
let lastMessageId = null;

// Функция загрузки сообщений
async function loadMessages() {
    const response = await fetch(`/chat/api/messages/${recipientId}/`);
    if (!response.ok) return;

    const data = await response.json();
    const messagesDiv = document.getElementById('messages');
    messagesDiv.innerHTML = '';

    data.messages.forEach(msg => {
        const isSent = msg.sender_id == {{ user.id }};
        const messageEl = document.createElement('div');
        messageEl.className = `d-flex mb-3 ${isSent ? 'justify-content-end' : 'justify-content-start'}`;

        const bubble = document.createElement('div');
        bubble.className = `message-bubble ${isSent ? 'sent' : 'received'}`;
        bubble.innerHTML = `
            <small class="text-muted d-block">${msg.timestamp}</small>
            <div>${msg.text}</div>
        `;
        messageEl.appendChild(bubble);
        messagesDiv.appendChild(messageEl);

        lastMessageId = msg.id;
    });
    // Прокрутка вниз
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

// Отправка сообщения
document.getElementById('message-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    const text = document.getElementById('message-input').value.trim();
    if (!text) return;

    const response = await fetch('{% url "chat:send_message" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            recipient_id: {{ recipient.id }},
            text: text
        })
    });

    if (response.ok) {
        document.getElementById('message-input').value = '';
        loadMessages(); // Обновляем сразу
    }
});

// Автоматическое обновление каждые 2 секунды
setInterval(loadMessages, 2000);

// Загружаем при старте
const recipientId = {{ recipient.id }};
loadMessages();
</script>
{% endblock %}